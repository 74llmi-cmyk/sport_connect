{% extends "base.html" %}

{% block title %}Activit√©s disponibles - Sport Connect{% endblock %}

{% block content %}
<!-- Images par sport -->
{% set sport_images = {
    'Running': 'https://images.unsplash.com/photo-1552674605-db6ffd4facb5?w=400&h=200&fit=crop',
    'Tennis': 'https://images.unsplash.com/photo-1554068865-24cecd4e34b8?w=400&h=200&fit=crop',
    'Yoga': 'https://images.unsplash.com/photo-1544367567-0f2fcb009e0b?w=400&h=200&fit=crop',
    'Football': 'https://images.unsplash.com/photo-1574629810360-7efbbe195018?w=400&h=200&fit=crop',
    'Natation': 'https://images.unsplash.com/photo-1530549387789-4c1017266635?w=400&h=200&fit=crop',
    'Basketball': 'https://images.unsplash.com/photo-1546519638-68e109498ffc?w=400&h=200&fit=crop',
    'Cyclisme': 'https://images.unsplash.com/photo-1541625602330-2277a4c46182?w=400&h=200&fit=crop'
} %}

<!-- Layout principal √† 2 colonnes -->
<div class="main-layout">
    <!-- Colonne gauche : Activit√©s -->
    <div class="activities-column">
        <!-- En-t√™te de page -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3>üèÉ Activit√©s disponibles</h3>
            <a href="{{ url_for('add') }}" class="btn btn-primary">+ Proposer une activit√©</a>
        </div>

        <!-- Section filtres -->
        <div class="filters-section">
            <form method="get" action="{{ url_for('index') }}" id="filter-form">
                <div class="row g-2">
                    <div class="col-md-3">
                        <select name="sport" class="form-select form-select-sm" onchange="autoSubmitFilter()">
                            <option value="">Tous les sports</option>
                            {% for sport in sports_list %}
                                <option value="{{ sport }}" {% if filters.sport == sport %}selected{% endif %}>
                                    {{ sport }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select name="niveau" class="form-select form-select-sm" onchange="autoSubmitFilter()">
                            <option value="">Tous les niveaux</option>
                            {% for niveau in niveaux_list %}
                                <option value="{{ niveau }}" {% if filters.niveau == niveau %}selected{% endif %}>
                                    {{ niveau }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select name="genre" class="form-select form-select-sm" onchange="autoSubmitFilter()">
                            <option value="">Tous publics</option>
                            {% for genre in genres_list %}
                                <option value="{{ genre }}" {% if filters.genre == genre %}selected{% endif %}>
                                    {{ genre }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="text" name="lieu" class="form-control form-control-sm"
                               placeholder="Filtrer par lieu..." value="{{ filters.lieu }}">
                    </div>
                </div>
            </form>
        </div>

        <!-- Grille des activit√©s -->
        <div class="activities-grid">
            {% if events %}
                {% for item in events %}
                <div class="activity-card {% if item.user_joined %}event-joined{% endif %}"
                     onclick="selectActivity({{ item.event.id }}, '{{ item.event.sport }}', '{{ item.event.lieu }}', '{{ item.event.date_heure }}', '{{ item.organizer_name }}', {{ item.event.latitude or 'null' }}, {{ item.event.longitude or 'null' }}, '{{ item.event.accessibilite or '' }}', {{ item.participant_count }}, '{{ item.event.transport_station or '' }}', '{{ item.event.transport_lines or '' }}', {{ 'true' if item.user_joined else 'false' }}, {{ 'true' if item.is_organizer else 'false' }})"
                     data-event-id="{{ item.event.id }}">

                    <!-- En-t√™te -->
                    <div class="activity-card-header">
                        <span class="activity-sport">{{ item.event.sport }}</span>
                        <span class="badge {% if item.event.niveau == 'D√©butant' %}niveau-debutant{% elif item.event.niveau == 'Interm√©diaire' %}niveau-intermediaire{% else %}niveau-expert{% endif %}">
                            {{ item.event.niveau }}
                        </span>
                    </div>
                    {% if item.user_joined or item.is_organizer %}
                    <span class="chat-notification-icon" id="notif-{{ item.event.id }}">
                        <span class="notif-count">0</span>
                    </span>
                    {% endif %}

                    <!-- Image -->
                    <img src="{{ sport_images.get(item.event.sport, 'https://images.unsplash.com/photo-1461896836934-68f78c8c46b6?w=400&h=200&fit=crop') }}"
                         class="activity-card-image" alt="{{ item.event.sport }}">

                    <!-- Contenu -->
                    <div class="activity-card-content">
                        <p class="activity-lieu">üìç {{ item.event.lieu }}</p>
                        <p class="activity-date">üïí {{ item.event.date_heure }}</p>

                        <div class="activity-badges">
                            {% if item.event.genre == 'Homme' %}
                            <span class="badge-genre badge-genre-homme">&#9794; Homme</span>
                            {% elif item.event.genre == 'Femme' %}
                            <span class="badge-genre badge-genre-femme">&#9792; Femme</span>
                            {% else %}
                            <span class="badge-genre badge-genre-mixte">&#9893; Mixte</span>
                            {% endif %}
                            {% if item.event.accessibilite %}
                            <span class="badge-pmr">‚ôø PMR</span>
                            {% endif %}
                            {% if item.event.latitude and item.event.longitude %}
                            <span class="badge-geo">üìç G√©olocalis√©</span>
                            {% endif %}
                        </div>

                        <!-- Badge transport -->
                        {% if item.event.transport_station %}
                        <div class="activity-transport">
                            <span class="transport-badge">üöá {{ item.event.transport_station }}</span>
                        </div>
                        {% endif %}

                        <!-- Boutons -->
                        <div class="activity-action">
                            {% if item.is_organizer %}
                                <div class="d-flex gap-2">
                                    <button onclick="event.stopPropagation(); openChatForEvent({{ item.event.id }}, '{{ item.event.sport }}')"
                                            class="btn btn-primary btn-sm flex-grow-1">
                                        üí¨ Chat
                                    </button>
                                    <button onclick="event.stopPropagation(); cancelEvent({{ item.event.id }}, this)"
                                            class="btn btn-cancel-event btn-sm">
                                        Annuler
                                    </button>
                                </div>
                            {% elif item.user_joined %}
                                <div class="d-flex gap-2">
                                    <button onclick="event.stopPropagation(); openChatForEvent({{ item.event.id }}, '{{ item.event.sport }}')"
                                            class="btn btn-primary btn-sm flex-grow-1">
                                        üí¨ Chat
                                    </button>
                                    <button onclick="event.stopPropagation(); leaveEvent({{ item.event.id }}, this)"
                                            class="btn btn-leave btn-sm">
                                        Quitter
                                    </button>
                                </div>
                            {% else %}
                                <button onclick="event.stopPropagation(); joinEvent({{ item.event.id }}, this)"
                                        class="btn btn-join btn-sm w-100">
                                    Rejoindre
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">üèÉ</div>
                    <h4>Aucune activit√© trouv√©e</h4>
                    <p class="text-muted">
                        {% if filters.sport or filters.niveau or filters.lieu or filters.genre %}
                            Aucun √©v√©nement ne correspond √† vos crit√®res.
                            <br><button onclick="resetFilters()" class="btn btn-outline-primary btn-sm mt-2">R√©initialiser</button>
                        {% else %}
                            <a href="{{ url_for('add') }}" class="btn btn-primary btn-sm mt-2">+ Proposer une activit√©</a>
                        {% endif %}
                    </p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Colonne droite : Sidepanel -->
    <div class="sidepanel" id="sidepanel">
        <!-- Vue carte (par d√©faut) -->
        <div id="sidepanel-map-view">
            <div class="sidepanel-header">
                <h5>üìç Trouver un lieu</h5>
            </div>

            <!-- Filtres du sidepanel -->
            <div class="sidepanel-filters">
                <select id="sidepanel-sport" class="form-select form-select-sm mb-2">
                    <option value="">Activit√©</option>
                    {% for sport in sports_list %}
                        <option value="{{ sport }}">{{ sport }}</option>
                    {% endfor %}
                </select>
                <input type="text" id="sidepanel-lieu" class="form-control form-control-sm" placeholder="Lieu" readonly>
            </div>

            <!-- Carte interactive -->
            <div id="sidepanel-map" class="sidepanel-map">
                <div class="map-placeholder">
                    <p>üó∫Ô∏è S√©lectionnez une activit√© pour voir sa localisation</p>
                </div>
            </div>

            <!-- D√©tails de l'activit√© s√©lectionn√©e -->
            <div id="sidepanel-details" class="sidepanel-details">
                <div class="no-selection">
                    <p>üëÜ Cliquez sur une activit√© pour voir les d√©tails</p>
                </div>
            </div>
        </div>

        <!-- Vue Chat (masqu√©e par d√©faut) -->
        <div id="sidepanel-chat-view" style="display: none;">
            <div class="sidepanel-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">üí¨ Chat <span id="chat-event-name"></span></h5>
                <button class="btn btn-sm btn-outline-light" onclick="closeChat()">‚úï Retour</button>
            </div>

            <!-- Zone des messages -->
            <div id="chat-messages" class="chat-messages">
                <div class="chat-empty">
                    <p>Aucun message pour le moment.<br>Soyez le premier √† √©crire !</p>
                </div>
            </div>

            <!-- Zone de saisie -->
            <div class="chat-input-container">
                <form id="chat-form" onsubmit="sendMessage(event)">
                    <div class="input-group">
                        <input type="text" id="chat-input" class="form-control" placeholder="Votre message..." autocomplete="off">
                        <button type="submit" class="btn btn-primary">Envoyer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Leaflet CSS & JS pour la carte -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// Variable pour stocker l'activit√© s√©lectionn√©e et la carte
let selectedActivity = null;
let sidepanelMap = null;
let mapMarker = null;

// Fonction pour soumettre automatiquement le formulaire de filtre
function autoSubmitFilter() {
    document.getElementById('filter-form').submit();
}

// Fonction pour r√©initialiser les filtres
function resetFilters() {
    window.location.href = '{{ url_for("index") }}';
}

// Fonction pour s√©lectionner une activit√©
function selectActivity(id, sport, lieu, dateHeure, organizer, lat, lng, accessibilite, participants, transportStation, transportLines, userJoined, isOrganizer) {
    // Mettre √† jour l'√©tat s√©lectionn√©
    selectedActivity = { id, sport, lieu, dateHeure, organizer, lat, lng, accessibilite, participants, transportStation, transportLines, userJoined, isOrganizer };

    // Mettre en surbrillance la carte s√©lectionn√©e
    document.querySelectorAll('.activity-card').forEach(card => {
        card.classList.remove('selected');
    });
    document.querySelector(`[data-event-id="${id}"]`).classList.add('selected');

    // Mettre √† jour les filtres du sidepanel
    document.getElementById('sidepanel-sport').value = sport;
    document.getElementById('sidepanel-lieu').value = lieu;

    // Mettre √† jour la carte
    updateSidepanelMap(lat, lng, lieu, sport);

    // Mettre √† jour les d√©tails
    updateSidepanelDetails(sport, lieu, dateHeure, organizer, accessibilite, participants, id, transportStation, transportLines);
}

// Fonction pour mettre √† jour la carte du sidepanel
function updateSidepanelMap(lat, lng, lieu, sport) {
    const mapContainer = document.getElementById('sidepanel-map');

    if (lat && lng) {
        // Supprimer le placeholder
        mapContainer.innerHTML = '<div id="leaflet-map" style="height: 200px; width: 100%; border-radius: 8px;"></div>';

        // Initialiser ou mettre √† jour la carte
        if (sidepanelMap) {
            sidepanelMap.remove();
        }

        sidepanelMap = L.map('leaflet-map').setView([lat, lng], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(sidepanelMap);

        // Ajouter un marqueur
        mapMarker = L.marker([lat, lng]).addTo(sidepanelMap)
            .bindPopup(`<b>${sport}</b><br>${lieu}`)
            .openPopup();
    } else {
        mapContainer.innerHTML = '<div class="map-placeholder"><p>üìç Pas de g√©olocalisation disponible pour cette activit√©</p></div>';
    }
}

// Fonction pour mettre √† jour les d√©tails du sidepanel
function updateSidepanelDetails(sport, lieu, dateHeure, organizer, accessibilite, participants, eventId, transportStation, transportLines) {
    const detailsContainer = document.getElementById('sidepanel-details');

    let accessBadge = '';
    if (accessibilite && accessibilite !== '') {
        accessBadge = '<span class="detail-badge-pmr">‚ôø Accessible PMR</span>';
    }

    // G√©n√©rer les badges de transport
    let transportHTML = '';
    if (transportStation && transportStation !== '') {
        transportHTML += `<div class="detail-transport">
            <p class="transport-station-label">üöá <strong>${transportStation}</strong></p>`;

        if (transportLines && transportLines !== '') {
            transportHTML += '<div class="transport-lines">';
            const lines = transportLines.split(',').map(l => l.trim());
            lines.forEach(line => {
                const lineClass = getLineClass(line);
                transportHTML += `<span class="line-badge ${lineClass}">${line}</span>`;
            });
            transportHTML += '</div>';
        }
        transportHTML += '</div>';
    }

    detailsContainer.innerHTML = `
        <div class="detail-card">
            <h6 class="detail-title">${sport}</h6>
            <p class="detail-lieu">üìç ${lieu}</p>
            <p class="detail-date">üïí ${dateHeure}</p>
            <p class="detail-organizer">üë§ Organis√© par ${organizer}</p>
            <p class="detail-participants">üë• ${participants} participant(s)</p>
            <div class="detail-badges">
                ${accessBadge}
            </div>
            ${transportHTML}
        </div>
    `;
}

// Fonction pour obtenir la classe CSS selon la ligne de transport
function getLineClass(line) {
    line = line.toUpperCase().trim();

    // Lignes de m√©tro
    if (line.startsWith('M') || /^[0-9]+$/.test(line)) {
        const num = line.replace('M', '');
        return `line-metro line-m${num}`;
    }
    // RER
    if (line.startsWith('RER')) {
        const letter = line.replace('RER', '').replace(' ', '');
        return `line-rer line-rer-${letter.toLowerCase()}`;
    }
    // Tramway
    if (line.startsWith('T')) {
        return 'line-tram';
    }
    // Bus
    if (line.startsWith('BUS') || /^[0-9]{2,3}$/.test(line)) {
        return 'line-bus';
    }
    return 'line-default';
}

// ===========================
// CHAT FUNCTIONALITY
// ===========================

let currentChatEventId = null;
let chatPollingInterval = null;
let lastMessageId = 0;
let unreadMessages = {};  // Stocke les messages non lus par event_id
let lastCheckedMessages = {};  // Dernier message v√©rifi√© par event
let notificationPollingInterval = null;

// Liste des √©v√©nements auxquels l'utilisateur participe
const joinedEventIds = [
    {% for item in events %}
        {% if item.user_joined or item.is_organizer %}{{ item.event.id }},{% endif %}
    {% endfor %}
];

// Ouvrir le chat
function openChat() {
    if (!selectedActivity) return;
    openChatForEvent(selectedActivity.id, selectedActivity.sport);
}

// Ouvrir le chat pour un √©v√©nement sp√©cifique
function openChatForEvent(eventId, sportName) {
    currentChatEventId = eventId;
    lastMessageId = 0;

    document.getElementById('sidepanel-map-view').style.display = 'none';
    document.getElementById('sidepanel-chat-view').style.display = 'block';
    document.getElementById('chat-event-name').textContent = '- ' + sportName;

    // R√©initialiser les notifications pour cet √©v√©nement
    resetNotifications(eventId);

    // Charger les messages
    loadMessages();

    // D√©marrer le polling
    if (chatPollingInterval) clearInterval(chatPollingInterval);
    chatPollingInterval = setInterval(pollMessages, 3000);
}

// Fermer le chat
function closeChat() {
    document.getElementById('sidepanel-map-view').style.display = 'block';
    document.getElementById('sidepanel-chat-view').style.display = 'none';

    // Arr√™ter le polling
    if (chatPollingInterval) {
        clearInterval(chatPollingInterval);
        chatPollingInterval = null;
    }

    currentChatEventId = null;
}

// Charger les messages
function loadMessages() {
    if (!currentChatEventId) return;

    fetch(`/api/event/${currentChatEventId}/messages`)
        .then(response => response.json())
        .then(data => {
            if (data.messages) {
                renderMessages(data.messages, false);
                if (data.messages.length > 0) {
                    lastMessageId = data.messages[data.messages.length - 1].id;
                    lastCheckedMessages[currentChatEventId] = lastMessageId;
                }
            }
        })
        .catch(err => console.error('Erreur chargement messages:', err));
}

// Polling pour nouveaux messages
function pollMessages() {
    if (!currentChatEventId) return;

    fetch(`/api/event/${currentChatEventId}/messages?since=${lastMessageId}`)
        .then(response => response.json())
        .then(data => {
            if (data.messages && data.messages.length > 0) {
                renderMessages(data.messages, true);
                lastMessageId = data.messages[data.messages.length - 1].id;
                lastCheckedMessages[currentChatEventId] = lastMessageId;

                // Notification pour messages des autres
                const newFromOthers = data.messages.filter(m => !m.is_mine);
                if (newFromOthers.length > 0) {
                    playNotificationSound();
                }
            }
        })
        .catch(err => console.error('Erreur polling:', err));
}

// Afficher les messages
function renderMessages(messages, append) {
    const container = document.getElementById('chat-messages');

    if (!append) {
        container.innerHTML = '';
    }

    if (messages.length === 0 && !append) {
        container.innerHTML = '<div class="chat-empty"><p>Aucun message pour le moment.<br>Soyez le premier √† √©crire !</p></div>';
        return;
    }

    // Supprimer le message vide si pr√©sent
    const emptyMsg = container.querySelector('.chat-empty');
    if (emptyMsg) emptyMsg.remove();

    messages.forEach(msg => {
        const msgDiv = document.createElement('div');
        msgDiv.className = `chat-message ${msg.is_mine ? 'chat-message-mine' : 'chat-message-other'}`;

        const initials = msg.username.substring(0, 2).toUpperCase();

        msgDiv.innerHTML = `
            ${!msg.is_mine ? `<div class="chat-avatar" style="background-color: ${msg.avatar_color}">${initials}</div>` : ''}
            <div class="chat-bubble">
                ${!msg.is_mine ? `<div class="chat-username">${msg.username}</div>` : ''}
                <div class="chat-content">${escapeHtml(msg.content)}</div>
            </div>
            ${msg.is_mine ? `<div class="chat-avatar" style="background-color: ${msg.avatar_color}">${initials}</div>` : ''}
        `;

        container.appendChild(msgDiv);
    });

    // Scroll en bas
    container.scrollTop = container.scrollHeight;
}

// Envoyer un message
function sendMessage(e) {
    e.preventDefault();

    const input = document.getElementById('chat-input');
    const content = input.value.trim();

    if (!content || !currentChatEventId) return;

    fetch(`/api/event/${currentChatEventId}/messages`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ content: content })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            renderMessages([data.message], true);
            lastMessageId = data.message.id;
            input.value = '';
        }
    })
    .catch(err => console.error('Erreur envoi:', err));
}

// Jouer le son de notification avec Web Audio API
function playNotificationSound() {
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        gainNode.gain.value = 0.3;

        oscillator.start();
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
        oscillator.stop(audioContext.currentTime + 0.3);
    } catch (e) {
        console.log('Audio notification not supported');
    }

    // Flash visuel sur l'en-t√™te du chat
    const chatHeader = document.querySelector('#sidepanel-chat-view .sidepanel-header');
    if (chatHeader) {
        chatHeader.classList.add('chat-notification-flash');
        setTimeout(() => chatHeader.classList.remove('chat-notification-flash'), 500);
    }
}


// √âchapper le HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Mettre √† jour le badge de notification sur une carte
function updateNotificationBadge(eventId, count) {
    const badge = document.getElementById('notif-' + eventId);
    if (badge) {
        if (count > 0) {
            badge.querySelector('.notif-count').textContent = count > 99 ? '99+' : count;
            badge.classList.add('visible');
        } else {
            badge.classList.remove('visible');
        }
    }
}

// V√©rifier les nouveaux messages pour tous les √©v√©nements rejoints
function checkAllNotifications() {
    joinedEventIds.forEach(eventId => {
        // Ne pas v√©rifier si le chat est ouvert pour cet √©v√©nement
        if (currentChatEventId === eventId) return;

        // Attendre que l'initialisation soit termin√©e pour cet √©v√©nement
        if (!(eventId in lastCheckedMessages)) return;

        const sinceId = lastCheckedMessages[eventId] || 0;

        fetch(`/api/event/${eventId}/messages?since=${sinceId}`)
            .then(response => response.json())
            .then(data => {
                if (data.messages && data.messages.length > 0) {
                    // Mettre √† jour le dernier message v√©rifi√©
                    lastCheckedMessages[eventId] = data.messages[data.messages.length - 1].id;

                    // Compter les nouveaux messages des autres
                    const newFromOthers = data.messages.filter(m => !m.is_mine);
                    if (newFromOthers.length > 0) {
                        // Incr√©menter les messages non lus
                        unreadMessages[eventId] = (unreadMessages[eventId] || 0) + newFromOthers.length;
                        updateNotificationBadge(eventId, unreadMessages[eventId]);

                        // Notification sonore
                        playNotificationSound();
                    }
                }
            })
            .catch(err => console.error('Erreur notification:', err));
    });
}

// R√©initialiser les notifications quand on ouvre le chat
function resetNotifications(eventId) {
    unreadMessages[eventId] = 0;
    updateNotificationBadge(eventId, 0);
}

// Initialiser la carte et les notifications
document.addEventListener('DOMContentLoaded', function() {
    // S√©lectionner automatiquement la premi√®re activit√© g√©olocalis√©e
    const firstGeoCard = document.querySelector('.activity-card[data-event-id]');
    if (firstGeoCard) {
        firstGeoCard.click();
    }

    // D√©marrer le polling des notifications pour les √©v√©nements rejoints
    if (joinedEventIds.length > 0) {
        console.log('√âv√©nements rejoints:', joinedEventIds);

        // Initialiser les derniers messages v√©rifi√©s avant de d√©marrer le polling
        const initPromises = joinedEventIds.map(eventId =>
            fetch(`/api/event/${eventId}/messages`)
                .then(response => response.json())
                .then(data => {
                    if (data.messages && data.messages.length > 0) {
                        lastCheckedMessages[eventId] = data.messages[data.messages.length - 1].id;
                    } else {
                        lastCheckedMessages[eventId] = 0;
                    }
                })
                .catch(err => {
                    console.error('Erreur fetch messages:', err);
                    lastCheckedMessages[eventId] = 0;
                })
        );

        // D√©marrer le polling seulement apr√®s l'initialisation
        Promise.all(initPromises).then(() => {
            notificationPollingInterval = setInterval(checkAllNotifications, 5000);
        });
    }
});

// Fonction de test pour afficher un badge (√† utiliser dans la console)
function testNotification(eventId) {
    updateNotificationBadge(eventId, 3);
}
</script>
{% endblock %}
